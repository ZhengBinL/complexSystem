<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>武警智慧磐石执勤安保信息管理平台</title>
    <!-- <title>执勤排班</title> -->
    <link rel="stylesheet" href="../../asset/introduce/layui/css/layui.css">
    <link rel="stylesheet" href="../../asset/css/reset.css">
    <link rel="stylesheet" href="../../asset/css/common.css">
    <link rel="stylesheet" href="./index.css">
</head>

<body>
  <!--头部-->
  <div class="header">
    <a class="header-lt" id="header" href="../index/index.html"></a>
    <div class="header-rt">
      <ul>
        <li class="notice-wrapper">
          <img class="notice-icon" src="../../asset/img/notice.png" alt="通知">
        </li>
        <li class="user-notice">
          <div id="user-operate" class="user-operate">
            <a href="javascript:;">
              <img class="user-img" src="../../asset/img/logo.png" alt="头像">
              管理
            </a>
            <a href="javascript:;" class="exit" title="退出">退出</a>
          </div>
        </li>
      </ul>
    </div>
  </div>


    <!-- 主内容：报警 -->
    <dl class="wrapper">
      <dt>
        <!--<span class="page-title">执勤排班</span>-->
        <div class="tabview">
          <ul class="tabtop">
            <li>
              <a href="../fixed-duty/fixed-duty.html">固定勤务</a>
            </li>
            <li class="on">
              <a href="javascript:void(0)">执勤排班</a>
            </li>
          </ul>
        </div>

        <div class="layui-form right-form">
          <div class="layui-form-item ">
              <div class="layui-inline">
                  <label class="layui-form-label">排班类型：</label>
                  <div class="layui-input-inline">
                      <select id="scheduleType" name="scheduleType">
                          <option value=""></option>
                          <option value="1">四包一</option>
                          <option value="2">五包一</option>
                          <option value="3">六包一</option>
                      </select>
                  </div>
              </div>
            <div class="layui-inline">
              <label class="layui-form-label">执勤时间：</label>
              <div class="layui-input-inline">
                <input type="text" name="dutyTime" id="dutyTime" autocomplete="off" class="layui-input js-laydate">
              </div>
            </div>

            <div class="layui-inline">
              <button class="layui-btn layui-btn-normal js-query">查询</button>
              <button class="layui-btn layui-btn-primary js-edit">修改</button>
            </div>

          </div>
        </div>
      </dt>

      <dd>
        <form class="layui-form">
        <table id="dutyList" class="table">
          <colgroup>
            <col width="33">
            <col width="130">
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
          </colgroup>
          <thead>
            <tr>
              <th colspan="2"><p>时间/班次</p></th>
              <th><p>网络查勤员</p></th>
              <th><p>一号岗</p></th>
              <th><p>二号岗</p></th>
              <th><p>三号岗</p></th>
              <th><p>四号岗</p></th>
              <th><p>五号岗</p></th>
              <th><p>六号岗</p></th>
              <th><p>七号岗</p></th>
              <th><p>八号岗</p></th>
              <th><p>应急组</p></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th rowspan="7" class="font-16">昼<br>间</th>
              <td><p>
                <span class="schedule">第一班</span>
                <span class="duty-time">6时-8时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
              <th rowspan="15" class="js-urgent"></th>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第二班</span>
                <span class="duty-time">8时-10时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第三班</span>
                <span class="duty-time">10时-12时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第四班</span>
                <span class="duty-time">12时-14时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第五班</span>
                <span class="duty-time">14时-16时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第六班</span>
                <span class="duty-time">16时-18时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第七班</span>
                <span class="duty-time">18时-20时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>

            <tr>
              <th rowspan="5" class="font-16">夜<br>间</th>
              <td><p>
                <span class="schedule">第一班</span>
                <span class="duty-time">20时-22时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第二班</span>
                <span class="duty-time">22时-24时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第三班</span>
                <span class="duty-time">0时-2时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第四班</span>
                <span class="duty-time">2时-4时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第五班</span>
                <span class="duty-time">4时-6时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <th rowspan="2" class="font-16"><p>在<br>外</p></th>
              <td>
                <p>应急班</p>
              </td>
              <td colspan="9" class="js-yingjiban">
                <!--<div class="txt-area">
                  <div class="js-onduty">
                    <span>张三<a href="javascript:;" class="btn-del">&times;</a></span>
                    <span>李四<a href="javascript:;" class="btn-del">&times;</a></span>
                  </div>
                  <a href="javascript:;" class="btn-select">选择</a>
                  <div class="select-area">
                    <input type="checkbox" name="write" lay-skin="primary" title="写作" checked="">
                    <input type="checkbox" name="read" lay-skin="primary" title="阅读">
                  </div>
                </div>-->
              </td>
            </tr>
            <tr>
              <td>
                <p>集训</p>
              </td>
              <td colspan="9" class="js-jixun">
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <p>机动</p>
              </td>
              <td colspan="9" class="js-jidong">
              </td>
            </tr>
          </tbody>
        </table>
        </form>
      </dd>
    </dl>

    <!--页脚-->
    <div class="footer">
      技术支持：北京国势通科技有限公司
    </div>
    <script src="../../asset/js/jquery.min.js"></script>
    <script src="../../asset/js/config.js"></script>
    <script type='text/javascript' src='/dwr/engine.js'></script>
    <script type='text/javascript' src='/dwr/interface/DwrImpl.js'></script>
    <script type='text/javascript' src='/dwr/util.js'></script>
    <script src="../../asset/js/utils.js"></script>
    <script src="../../asset/introduce/layui/layui.js"></script>

    <script>
      layui.use(['laydate','table','form'], function(){
        var laydate = layui.laydate;
        var form = layui.form;
        var d = formatDate();
        laydate.render({
          elem: '.js-laydate',
          value: d,
          format: 'yyyy-MM-dd'
        })

        var layer = layui.layer;
        querySchedule(d, form);

        $('.js-query').on('click',function () {
          var val = $('#dutyTime').val();
          if(val.trim() === ''){
            layer.alert('请选择查询日期！')
            return false;
          }
          querySchedule(val, form);
        })

		var tower;
		var mirror;


		function copy(before, after) {
			var date = $('#dutyTime').val() || formatDate()
			var watchScheduleList = [];

			var rowid = after.attr("rowid");
			var tds = after.find('td');

			var resources = before.find('td');

			for(var j = 1; j <= 9; j++) {
				var columnid = tower[j - 1].id;
				var cellid = $(tds[j]).attr("cellid");

				var pid = $(resources[j]).find("p").attr('pid');

				var json = {
					personnelId: pid,
					type: "2",
					watchHourId: rowid,
					watchTime: date,
					watchTowerId: columnid,
				}

				if(cellid)
					json.id = cellid;

				watchScheduleList.push(json)
			}

			$.ajax({
				url: $ctx + '/watch_schedule/saveOrUpdate',
				data: JSON.stringify( watchScheduleList ),
				contentType: 'application/json',
				type: 'put'
			}).done(function(res) {
				$('.js-edit').text('修改成功')
				querySchedule(date);
			});
		}

    function querySchedule(d, form){
      var t = new Date().getTime();
      $.ajax({
        url: $ctx + '/watch_schedule/getListByWatchTime/'+ d + '?' + t,
        type: 'get'
      }).done(function(res) {
        var dt = res.data.list;
        //根据后台返回值，确定下拉框的值
        for(var i=0;i<$('#scheduleType').find('option').length;i++){
            if($('#scheduleType').find('option').eq(i).attr('value')==res.data.scheduleType){
              $('#scheduleType').find('option').eq(i).attr('selected',true);
            }else{
              $('#scheduleType').find('option').eq(i).removeAttr('selected');
            }
        }
        // form.render('select');
        for(var i = 0; i < dt.length; i++){
          var $tr = $('#dutyList>tbody>tr').eq(i);
          $tr.addClass('js-isEdit isedit');
          var _dt = dt[i];
          var innerDt = _dt.personnelList;
          for(var j = 0; j < 9; j++) {
            var $td = $tr.find('td').eq(j+1);
            var _html = '';
            _html += '<p class="layui-input-inline hide-elm js-select">';
            _html += '  <select name="dutyman-' + i + '-' + j +'" lay-verify="required" lay-search="" data-index='+innerDt[j].id+'>';
            _html += '  <option value="'+innerDt[j].personnelId+'" data-rank='+innerDt[j].militaryRank+'>' + innerDt[j].personnelName + '(' + innerDt[j].militaryRankName + ')</option>';
            _html += '  </select>';
            _html += '</p>';
            if (j === (innerDt.length - 1)) {
              _html += '<p pid="' + innerDt[j].personnelId + '" class="js-onduty">' + innerDt[j].personnelName;
              _html += '  <span class="ranks">(' + innerDt[j].militaryRankName + ')</span>';
              _html += '  <div class="opt-outer">';
              _html += '    <div class="table-opt">';
              _html += '      <a href="javascript:;" class="js-copy btn-row">复制</a>';
              _html += '      <a href="javascript:;" class="js-paste btn-row">粘贴</a>';
              _html += '    </div>';
              _html += '  </div>';
              _html += '</p>';
            } else {
              _html += '<p class="js-onduty" pid="' + innerDt[j].personnelId + '">' + innerDt[j].personnelName + '<span class="ranks">' + innerDt[j].militaryRankName + '</span></p>'
            }
            $td.html(_html)
          }
        }

        $('.js-copy').click(function() {
          mirror = $(this).parent().parent().parent().parent();
          layer.msg('复制成功');
        });

        $('.js-paste').click(function() {
          if(!mirror) {
            layer.msg('请先复制再粘贴');
            return;
          }

          var row = $(this).parent().parent().parent().parent();
          copy(mirror, row);
        });
        queryOuter(d, form);
      }).fail(function(err) {
        console.log(err)
      })
    }

    function queryOuter(d, form){
		  var t = new Date().getTime();
			$.ajax({
				url: $ctx + '/watch_schedule/getOutPersonnelByDate/'+ d + '?' + t,
				type: 'get'
			}).done(function(res) {
				var dt = res.data;
        var ids = [];
				for(var i=0; i<dt.length; i++){
				  var _html = '';
          var $tr = $('#dutyList>tbody>tr').eq(i+12);
					var _dt = dt[i];
					var innerDt = _dt.list;
					var innerHtml = '';
					var innerTxt = '';
					var _style = (i===3) ? 'text-area' : 'txt-area';
					if(i===3){
            innerTxt = innerDt.map(function(item){
              return item.personnelName;
            }).join('<br>');
          }else{
            innerTxt = innerDt.map(function(item){
              return item.personnelName;
            }).join('，');
          }

					for(var j = 0; j<innerDt.length; j++) {
					  ids.push(innerDt[j].personnelId);
            innerHtml += '<span data-id="' + innerDt[j].personnelId + '">' + innerDt[j].personnelName + '<a href="javascript:;" class="btn-del">&times;</a></span>';
					}
          var dutyHtml = '';
          if(i===3){
            dutyHtml += '<p class="js-onduty">' + innerTxt + '</p>';
            dutyHtml += '<div class="' + _style + ' hide-elm js-select">';
            dutyHtml += '  <div class="show-select">';
            dutyHtml += innerHtml + '  </div>';
            dutyHtml += '  <a href="javascript:;" class="btn-select">选择</a>';
            dutyHtml += '  <ul class="select-area">';
            dutyHtml += '    <li>';
            dutyHtml += '    </li>';
            dutyHtml += '  </ul>';
            dutyHtml += '</div>';
            $('#dutyList').find('.js-urgent').html(dutyHtml);
          }else{
            dutyHtml += '<p class="js-onduty">' + innerTxt + '</p>';
            dutyHtml += '<div class="' + _style + ' hide-elm js-select">';
            dutyHtml += '  <ul class="select-area">';
            dutyHtml += '    <li>';
            dutyHtml += '    </li>';
            dutyHtml += '  </ul>';
            dutyHtml += '  <div class="show-select">';
            dutyHtml += innerHtml + '  </div>';
            dutyHtml += '  <a href="javascript:;" class="btn-select">选择</a>';
            dutyHtml += '</div>';
            $tr.find('td').eq(1).html(dutyHtml);
          }
				}

        $('.js-edit').off().on('click',function(e) {
          if($('.js-edit').text() == "保存") {
            $('.js-edit').text('修改')
            $('.js-select').addClass('hide-elm');
            $('.js-textarea').addClass('hide-elm');
            $('.js-onduty').show();
            $('.js-isEdit').addClass('isedit');

            //开始保存
            toSave();
          } else {
            $('.js-edit').text('保存')
            $('.js-select').removeClass('hide-elm');
            $('.js-textarea').removeClass('hide-elm');
            $('.js-onduty').hide();
            $('.js-isEdit').removeClass('isedit');
            // form.render('select');
            $.ajax({
              type:'GET',
              url:$ctx+'/sys_armed_police/findPersonnelByNameAndRank?name=&ranks=3,4,5',
            }).done(function(res){
              var resDate = res.data;
              var _html="";
              for(var i=0;i<resDate.length;i++){
                _html += '<option value="'+resDate[i].id+'" data-rank='+resDate[i].militaryRank+'>' + resDate[i].personnelName + '(' + resDate[i].militaryRankName + ')</option>';
              }
              
              for(var j=0;j<108;j++){
                if($('.js-select').eq(j).find('select').attr('name')){
                  if($('.js-select').eq(j).find('select').attr('name').split('-')[2]==0){
                    $('.js-select').eq(j).find('select').append(_html)
                  }
                }
              }
              form.render('select');
            })
             $.ajax({
              type:'GET',
              url:$ctx+'/sys_armed_police/findPersonnelByNameAndRank?name=&ranks=',
            }).done(function(res){
              var resDate = res.data;
              var _html="";
              for(var i=0;i<resDate.length;i++){
                _html += '<option value="'+resDate[i].id+'" data-rank='+resDate[i].militaryRank+'>' + resDate[i].personnelName + '(' + resDate[i].militaryRankName + ')</option>';
              }
              for(var j=0;j<109;j++){
                if($('.js-select').eq(j).find('select').attr('name')){
                  if($('.js-select').eq(j).find('select').attr('name').split('-')[2]!=0){
                    $('.js-select').eq(j).find('select').append(_html)
                  }
                }
              }
              form.render('select');
            })

          }
        });

        $('.btn-select').on('click',function(e){
          e.stopPropagation();
          var $tis = $(this);
          if($tis.parent('.js-select').find('.select-area li').find('label').length>0){
            $tis.parent('.js-select').find('.select-area').show()
          }else{
            renderSelectarea($tis,ids);
          }
        })
      }).fail(function(err) {
        console.log(err)
      })
		}

		function renderSelectarea(tis, ids){
      $.ajax({
        url: $ctx + '/sys_armed_police/findPersonnelByNameAndRank',
        type: 'get'
      }).done(function(res) {
        var dt = res.data;
        var chkHtml = '';
        for(var i=0; i<dt.length; i++){
          var item = dt[i];
          var isCheck = false;
          var _title = item.personnelName + '(' + item.militaryRankName + ')';
          for(var j=0; j<ids.length; j++){
            if(ids[j]===item.id){
              isCheck = true;
              break;
            }
          }
          if(isCheck){
            chkHtml += '<label class="chkbox"><input type="checkbox" name="soldier" data-name="' + item.personnelName + '" value="' + item.id + '" checked="">' + _title + '<i></i></label>'
          }else{
            chkHtml += '<label class="chkbox"><input type="checkbox" name="soldier" data-name="' + item.personnelName + '" value="' + item.id + '">' + _title + '<i></i></label>'
          }
        }
        tis.parent('.js-select').find('.select-area').show().find('li').html(chkHtml);

        $("input[name='soldier']").click(function(){
          var $tis = $(this);
          var val = $tis.val();
          if($tis.prop('checked')){
            var str = '<span data-id="' + val + '">' + $tis.attr('data-name') + '<a href="javascript:;" class="btn-del">&times;</a></span>';
            $tis.parents('.js-select').find('.show-select').append(str);
          }else{
            $tis.parents('.js-select').find('.show-select span').each(function(){
              var $that = $(this);
              if(val === $that.attr('data-id')){
                $that.remove();
              }
            })
          }

          $('.btn-del').off().on('click',function(){
            var $tis = $(this);
            var val = $tis.parent('span').attr('data-id');
            $tis.parents('.js-select').find('input[name="soldier"]').each(function(){
              var $that = $(this);
              if(val === $that.val()){
                $that.prop('checked',false);
                $tis.parent('span').remove();
              }
            })
          })
        });

        $(document).click(function () {
          $('.select-area').hide();
        })
        $('.select-area').click(function (e) {
          e.stopPropagation()
        })

      }).fail(function(err) {
        console.log(err)
      })
    }

    function toSave(){
      var jddata = [];
      $('.js-jidong').find('.show-select span').each(function(){
        jddata.push($(this).attr('data-id'));
      })
      var jxdata = [];
      $('.js-jixun').find('.show-select span').each(function(){
        jxdata.push($(this).attr('data-id'));
      })
      var yjbdata = [];
      $('.js-yingjiban').find('.show-select span').each(function(){
        yjbdata.push($(this).attr('data-id'));
      })
      var yjzdata = [];
      $('.js-urgent').find('.show-select span').each(function(){
        yjzdata.push($(this).attr('data-id'));
      })
      var params = {
        jdPersonnelIdList: jddata,
        jxPersonnelIdList: jxdata,
        yjbPersonnelIdList: yjbdata,
        yjzPersonnelIdList: yjzdata,
        watchScheduleList: [],
        watchTime: $('#dutyTime').val()
      }
    }

    form.on('select()', function(data){
      var dataValue = {
				watchScheduleList: [
          {
            "id": $(data.elem).attr('data-index'),
            "personnelId":data.value,
          }
          ],
				jdPersonnelIdList: [],
				jxPersonnelIdList: [],
				yjbPersonnelIdList: [],
				yjzPersonnelIdList: [],
			}
      // console.log(dataValue,'data')
      $.ajax({
				url: $ctx + '/watch_schedule/saveOrUpdate',
				data: JSON.stringify(dataValue),
				contentType: 'application/json',
				type: 'put'
			}).done(function(res) {
				$('.js-edit').text('修改')
				querySchedule();
			});
    });
  })
    </script>
</body>

</html>