<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>武警智慧磐石执勤安保信息管理平台</title>
    <!-- <title>执勤排班</title> -->
    <link rel="stylesheet" href="../../asset/introduce/layui/css/layui.css">
    <link rel="stylesheet" href="../../asset/css/reset.css">
    <link rel="stylesheet" href="../../asset/css/common.css">
    <link rel="stylesheet" href="./index.css">
</head>

<body>
  <!--头部-->
  <div class="header">
    <a class="header-lt" id="header" href="../index/index.html"></a>
    <div class="header-rt">
      <ul>
        <li class="notice-wrapper">
          <img class="notice-icon" src="../../asset/img/notice.png" alt="通知">
        </li>
        <li class="user-notice">
          <div id="user-operate" class="user-operate">
            <a href="javascript:;">
              <img class="user-img" src="../../asset/img/logo.png" alt="头像">
              管理
            </a>
            <a href="javascript:;" class="exit" title="退出">退出</a>
          </div>
        </li>
      </ul>
    </div>
  </div>


    <!-- 主内容：报警 -->
    <dl class="wrapper">
      <dt>
        <span class="page-title">执勤排班</span>
        <div class="layui-form right-form">
          <div class="layui-form-item ">
              <div class="layui-inline">
                  <label class="layui-form-label">排班类型：</label>
                  <div class="layui-input-inline">
                      <select id="scheduleType" name="scheduleType">
                          <option value=""></option>
                          <option value="1">四包一</option>
                          <option value="2">五包一</option>
                          <option value="3">六包一</option>
                      </select>
                  </div>
              </div>
            <div class="layui-inline">
              <label class="layui-form-label">执勤时间：</label>
              <div class="layui-input-inline">
                <input type="text" name="dutyTime" id="dutyTime" autocomplete="off" class="layui-input js-laydate">
              </div>
            </div>

            <div class="layui-inline">
              <button class="layui-btn layui-btn-normal js-query">查询</button>
              <button class="layui-btn layui-btn-primary js-edit">修改</button>
            </div>

          </div>
        </div>
      </dt>

      <dd>
        <form class="layui-form">
        <table id="dutyList" class="table">
          <colgroup>
            <col width="33">
            <col width="130">
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
          </colgroup>
          <thead>
            <tr>
              <th colspan="2"><p>时间/班次</p></th>
              <th><p>网络查勤员</p></th>
              <th><p>一号岗</p></th>
              <th><p>二号岗</p></th>
              <th><p>三号岗</p></th>
              <th><p>四号岗</p></th>
              <th><p>五号岗</p></th>
              <th><p>六号岗</p></th>
              <th><p>七号岗</p></th>
              <th><p>八号岗</p></th>
              <th><p>应急组</p></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th rowspan="7" class="font-16">昼<br>间</th>
              <td><p>
                <span class="schedule">第一班</span>
                <span class="duty-time">6时-8时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
              <th rowspan="15" class="js-urgent"></th>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第二班</span>
                <span class="duty-time">8时-10时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第三班</span>
                <span class="duty-time">10时-12时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第四班</span>
                <span class="duty-time">12时-14时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第五班</span>
                <span class="duty-time">14时-16时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第六班</span>
                <span class="duty-time">16时-18时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第七班</span>
                <span class="duty-time">18时-20时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>

            <tr>
              <th rowspan="5" class="font-16">夜<br>间</th>
              <td><p>
                <span class="schedule">第一班</span>
                <span class="duty-time">20时-22时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第二班</span>
                <span class="duty-time">22时-24时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第三班</span>
                <span class="duty-time">0时-2时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第四班</span>
                <span class="duty-time">2时-4时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <td><p>
                <span class="schedule">第五班</span>
                <span class="duty-time">4时-6时</span>
              </p></td>
              <td></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"></td>
              <td class="orange"></td>
              <td class="cyan"><p>
                </p></td>
            </tr>
            <tr>
              <th rowspan="2" class="font-16"><p>在<br>外</p></th>
              <td>
                <p>应急班</p>
              </td>
              <td colspan="9">
                <div class="txt-area">
                  <span>张三<a href="javascript:;" class="btn-del">&times;</a></span>
                  <span>李四<a href="javascript:;" class="btn-del">&times;</a></span>
                  <a href="javascript:;" class="btn-select">&times;</a>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <p>集训</p>
              </td>
              <td colspan="9"></td>
            </tr>
            <tr>
              <td colspan="2">
                <p>机动</p>
              </td>
              <td colspan="9"></td>
            </tr>
          </tbody>
        </table>
        </form>
      </dd>
    </dl>

    <!--页脚-->
    <div class="footer">
      技术支持：北京国势通科技有限公司
    </div>
    <script src="../../asset/js/jquery.min.js"></script>
    <script src="../../asset/js/config.js"></script>
    <!-- <script type='text/javascript' src='/dwr/engine.js'></script>
    <script type='text/javascript' src='/dwr/interface/DwrImpl.js'></script>
    <script type='text/javascript' src='/dwr/util.js'></script> -->
    <script src="../../asset/js/utils.js"></script>
    <script src="../../asset/introduce/layui/layui.js"></script>
    <script src="./index.js"></script>

    <script>
      layui.use(['laydate','table','form'], function(){
        var laydate = layui.laydate;
        var form = layui.form;
        var d = formatDate();
        laydate.render({
          elem: '.js-laydate',
          value: d,
          format: 'yyyy-MM-dd'
        })

        var layer = layui.layer;
        querySchedule(d, form);
        
        $('.js-query').on('click',function () {
          var val = $('#dutyTime').val();
          if(val.trim() === ''){
            layer.alert('请选择查询日期！')
            return false;
          }
          querySchedule(val, form);
        })
		
		var officer;
		var police;
		var tower;
		var mirror;
		
		// 初始化人员
		(function () {
			$.ajax({
				url: $ctx + '/sys_armed_police/findPersonnelByNameAndRank',
				type: 'get'
			}).done(function(res) {
				officer = res.data;
			});
			$.ajax({
				url: $ctx + '/sys_armed_police/find_police_list/1/99999999',
				type: 'post',
			}).done(function(res) {
				police = res.data.list;
			});
			$.ajax({
				url: $ctx + '/watch_tower/getList',
				type: 'get',
			}).done(function(res) {
				tower = res.data;
			});
		})();
		
		function copy(before, after) {
			var date = $('#dutyTime').val() || formatDate()
			var watchScheduleList = [];
			
			var rowid = after.attr("rowid");
			var tds = after.find('td');
			
			var resources = before.find('td');
			
			for(var j = 1; j <= 9; j++) {
				var columnid = tower[j - 1].id;
				var cellid = $(tds[j]).attr("cellid");
				
				var pid = $(resources[j]).find("p").attr('pid');
				
				var json = {
					personnelId: pid,
					type: "2",
					watchHourId: rowid,
					watchTime: date,
					watchTowerId: columnid,
				}
				
				if(cellid)
					json.id = cellid;
				
				watchScheduleList.push(json)
			}
			
			$.ajax({
				url: $ctx + '/watch_schedule/saveOrUpdate',
				data: JSON.stringify( watchScheduleList ),
				contentType: 'application/json',
				type: 'put'
			}).done(function(res) {
				$('.js-edit').text('修改成功')
				querySchedule(date);
			});
		}
		
		function getOfficer(id) {
			var select = $('<select></select>');
			for(var i = 0; i < officer.length; i++) {
				select.append($('<option></option>')
					.val(officer[i].id)
					.attr("selected", id == officer[i].id)
					.text(officer[i].personnelName + "(" + officer[i].militaryRankName + ")"))
			}
			return select;
		}
		
		function getPolice(id) {
			var select = $('<select></select>');
			for(var i = 0; i < police.length; i++) {
				select.append($('<option></option>')
					.val(police[i].id)
					.attr("selected", id == police[i].id)
					.text(police[i].personnelName + "(" + police[i].militaryRankName + ")"))
			}
			return select;
		}
		
    function querySchedule(d, form){
      // var _d = d;
      var _d = '2019-05-21';
      $.ajax({
        url: $ctx + '/watch_schedule/getListByWatchTime/'+ _d,
        type: 'get'
      }).done(function(res) {
        var dt = res.data.list;
        //根据后台返回值，确定下拉框的值
        for(var i=0;i<$('#scheduleType').find('option').length;i++){
            if($('#scheduleType').find('option').eq(i).attr('value')==res.data.scheduleType){
              $('#scheduleType').find('option').eq(i).attr('selected',true);
            }else{
              $('#scheduleType').find('option').eq(i).removeAttr('selected');
            }
        }
        form.render('select');
        for(var i = 0; i < dt.length; i++){
          var $tr = $('#dutyList>tbody>tr').eq(i);
          $tr.addClass('js-isEdit isedit');
          var _dt = dt[i];
          var innerDt = _dt.personnelList;
          for(var j = 0; j < 9; j++) {
            var $td = $tr.find('td').eq(j+1);
            var _html = '';
            _html += '<p class="layui-input-inline hide-elm js-select" onclick="return false;">';
            _html += '  <select name="dutyman-' + i + '-' + j +'" lay-verify="required" lay-search="">';
            _html += '  <option value="'+innerDt[j].personnelName+'" data-rank='+innerDt[j].militaryRank+'>' + innerDt[j].personnelName + '(' + innerDt[j].militaryRankName + ')</option>';
            _html += '  </select>';
            _html += '</p>';
            if (j === (innerDt.length - 1)) {
              _html += '<p pid="' + innerDt[j].personnelId + '" class="js-onduty">' + innerDt[j].personnelName;
              _html += '  <span class="ranks">(' + innerDt[j].militaryRankName + ')</span>';
              _html += '  <div class="opt-outer">';
              _html += '    <div class="table-opt">';
              _html += '      <a href="javascript:;" class="js-copy btn-row">复制</a>';
              _html += '      <a href="javascript:;" class="js-paste btn-row">粘贴</a>';
              _html += '    </div>';
              _html += '  </div>';
              _html += '</p>';
            } else {
              _html += '<p class="js-onduty" pid="' + innerDt[j].personnelId + '">' + innerDt[j].personnelName + '<span class="ranks">' + innerDt[j].militaryRankName + '</span></p>'
            }
            $td.html(_html)
          }
        }

        $('.js-copy').click(function() {
          mirror = $(this).parent().parent().parent().parent();
          layer.msg('复制成功');
        });

        $('.js-paste').click(function() {
          if(!mirror) {
            layer.msg('请先复制再粘贴');
            return;
          }

          var row = $(this).parent().parent().parent().parent();
          copy(mirror, row);
        });
        queryOuter(_d, form);
      }).fail(function(err) {
        console.log(err)
      })
    }

    function queryOuter(d, form){
			$.ajax({
				url: $ctx + '/watch_schedule/getOutPersonnelByDate/'+ d,
				type: 'get'
			}).done(function(res) {
				var dt = res.data;
				for(var i=0; i<(dt.length-1); i++){
				  var _html = '';
          var $tr = $('#dutyList>tbody>tr').eq(i+12);
					var _dt = dt[i];
					var innerDt = _dt.list;
					var innerHtml = ''
					for(var j = 0; j<innerDt.length; j++) {
						innerHtml += innerDt[j].personnelName + '，'
					}
					innerHtml = innerHtml.slice(0,-1);

					var ids = innerDt.map(function(item){
						return item.personnelId;
					}).join(',');

					/*var type = {0:'yjbPersonnelIdList', 1:'jxPersonnelIdList', 2:'jdPersonnelIdList'}[i];
					_html += '<p class="js-textarea hide-elm" ids="' + ids + '"><input type="text" class="layui-input" value="' + innerHtml + '" /></p>'
					_html += '<p class="save_type js-onduty" type="' + type + '" ids="' + ids + '">' + innerHtml + '</p>'
          $tr.find('td').eq(1).html(_html);*/
				}

				var _last = dt[3].list;
				var _urgents = _last.map(function(item){
					return item.personnelName;
				}).join('<br>');
				var ids = _last.map(function(item){
					return item.personnelId;
				}).join(',');
				var urgentHtml = '';
				urgentHtml += '<p class="text-area hide-elm js-textarea">' + _urgents + '</p>';
				urgentHtml += '<p class="js-onduty">' + _urgents + '</p>';
				$('.js-urgent').attr("ids", ids).html(urgentHtml);

        $('.js-edit').on('click',function() {
          if($('.js-edit').text() == "保存") {
            $('.js-edit').text('修改')
            $('.js-select').addClass('hide-elm');
            $('.js-textarea').addClass('hide-elm');
            $('.js-onduty').show();
            $('.js-isEdit').addClass('isedit');
          } else {
            $('.js-edit').text('保存')
            $('.js-select').removeClass('hide-elm');
            $('.js-textarea').removeClass('hide-elm');
            $('.js-onduty').hide();
            $('.js-isEdit').removeClass('isedit');
            form.render('select');
          }
        });
			}).fail(function() {
				layer.msg('请求错误')
			})
		}
     
    
    // 点击下拉框渲染下拉列表
    $('body').off('click').on('click','.js-select',function(){

      console.log("111111111")
      // var personName = $(this).find('option').val();
      var _this = this;
      if($(_this).find(".layui-form-select").hasClass(".layui-form-selected")){
        alert(1)
      }
      var personName ='';
      var rankNum = $(this).find('option').attr('data-rank');
      // console.log(rankNum)
      if(rankNum ==3||rankNum ==4||rankNum ==5){
        rankNum = '3,4,5'
      }else{
        rankNum = ''
      }
        $.ajax({
          type:'GET',
          // async:false,
          url:$ctx+'/sys_armed_police/findPersonnelByNameAndRank?name='+personName+'&ranks='+rankNum,
        }).done(function(res){
          var resDate = res.data
          var _html=""
          for(var i=0;i<resDate.length;i++){
            _html += '<option value="'+resDate[i].personnelName+'" data-rank='+resDate[i].militaryRank+'>' + resDate[i].personnelName + '(' + resDate[i].militaryRankName + ')</option>';
          }
          $(_this).find('select').html(_html);
          // console.log(form.render)
          // setTimeout(function(){
          //   form.render('select');
          // }, 10000)
          form.render('select');

        })
    })

 
    // 在下拉框中进行修改，支持模糊搜索
    $('body').on('input','input',function(){
      var personName = $(this).val().split('(')[0].toString();
      var rankNum = $(this).parents('.js-select').find('option').attr('data-rank');
      console.log(rankNum)
        $.ajax({
          type:'GET',
          url:$ctx+'/sys_armed_police/findPersonnelByNameAndRank?name='+personName+'&ranks='+rankNum,
        }).done(function(){
          //请求回来数据，然后进行渲染
        })
    })
  })
    </script>
    <script>

    </script>
</body>

</html>